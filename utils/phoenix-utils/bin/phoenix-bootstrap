#!/bin/bash

set -e

WORKDIR=$PWD
ME=$(basename $0)
MYDIR=$(dirname $0)
MYDIR=$(cd $MYDIR/.. && pwd)

PHOENIX_CONF=$WORKDIR/phoenix.conf

##CPKG_DIRS##
# CPKG BOOTSTRAP BEGIN
if [ -z "$LIBDIR" ]; then
    export BINDIR=$MYDIR/bin
    export ETCDIR=$MYDIR/etc
    export LIBDIR=$MYDIR/lib
    export SHAREDIR=$MYDIR/share
    export VARDIR=$MYDIR/var
    export LOGDIR=$MYDIR/log
fi
# CPKG BOOTSTRAP END

if [[ -f $PHOENIX_CONF ]]; then
    . $PHOENIX_CONF
    [[ -z "$PKG_VER" ]] && PKG_VER=1.0
    (($PKG_REV)) || PKG_REV=1
    
    [[ -z "$PRJ_NAME" ]] && (echo "PRJ_NAME not set" && exit 1)
    [[ -z "$PRJ_SERVER" ]] && PRJ_SERVER=$PRJ_NAME
fi
PKG_NAME=${PRJ_NAME//_/-}

. $(cpkg-config -L)

subs() {
    local VAR=$1
    local VALUE=$2
    local FILE=$3

    sed -e "s/##${VAR}##/${VALUE}/g" $FILE
}

##################################################
#
# Main
#
##################################################

# Name
PROJECT=$PRJ_NAME
PROJECT_DEV=${PROJECT}-dev
PROJECT_DIR=$WORKDIR
PROJECT_BUILD=/tmp/$PROJECT
[ -d $PROJECT_BUILD ] && rm -rf $PROJECT_BUILD
mkdir -p $PROJECT_DIR $PROJECT_BUILD

# Generate docker builder for project
subs "USER_ID" $UID  $SHAREDIR/support/builder-dev/Dockerfile > $PROJECT_BUILD/Dockerfile
docker build -t $PROJECT_DEV $PROJECT_BUILD
docker run -d --name=$PROJECT_DEV --net=host -v $PWD:/src/app $PROJECT_DEV

# Generate Docker file
cat <<EOF > $PROJECT_DIR/Dockerfile.onbuild
FROM ddway2/phoenix-onbuild

CMD ["/usr/bin/${PRJ_SERVER}"]
EOF

cat <<EOF > $PROJECT_DIR/Dockerfile.dev
FROM ddway2/phoenix-dev

CMD ["bash"]
EOF

# Generate project structure
INCLUDE_DIR=$PROJECT_DIR/sources/include/${PROJECT}
BINARIES_DIR=$PROJECT_DIR/sources/binaries/${PRJ_SERVER}
mkdir -p $INCLUDE_DIR $BINARIES_DIR
cat <<EOF > $PROJECT_DIR/cbuild.conf
PKG_CATS=(
    [deb]=devel
    [pkgsrc]=devel
)
PKG_VER=$PKG_VER
PKG_REV=$PKG_REV
PKG_SHORTDESC="$PROJECT app"
PKG_LONGDESC="
packaging for $PROJECT app
"

# cbuild settings
PRJ_NAME=$PROJECT
PRJ_OPTS["std"]=c++14
EOF

cd $PROJECT_DIR
git init
echo "**/CMakeList.txt" > .gitignore


##############################################################################
#
# POD Documentation
#
##############################################################################
: <<=cut
=pod

=head1 NAME

phoenix-bootstrap - C/C++ automated project bootstrap configurator

=head1 DESCRIPTION

phoenix-bootstrap is very nice.

=head1 SYNOPSIS

  phoenix-bootstrap

=cut

