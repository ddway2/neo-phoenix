#!/bin/bash

set -e

WORKDIR=$PWD
ME=$(basename $0)
MYDIR=$(dirname $0)
MYDIR=$(cd $MYDIR && pwd)

##CPKG_DIRS##
# CPKG BOOTSTRAP BEGIN
if [ -z "$LIBDIR" ]; then
    export BINDIR=$MYDIR/bin
    export ETCDIR=$MYDIR/etc
    export LIBDIR=$MYDIR/lib
    export SHAREDIR=$MYDIR/share
    export VARDIR=$MYDIR/var
    export LOGDIR=$MYDIR/log
fi
# CPKG BOOTSTRAP END

. $(cpkg-config -L)

sub subs() {
    local VAR=$1
    local VALUE=$2
    local FILE=$3
    
    sed -e "s/##${VAR}##/${VALUE}/g" $FILE
}

##################################################
#
# Main
#
##################################################

# Generate builder-dev images
[ -d /tmp/build-dev ] && rm -rf /tmp/build-dev
mkdir /tmp/build-dev
subs "USER_ID" $UID  $SHAREDIR/support/builder-dev/Dockerfile > /tmp/build-dev/Dockerfile
subs "USER_GID" $GID  $SHAREDIR/support/builder-dev/Dockerfile > /tmp/build-dev/Dockerfile
docker build -t builder-dev /tmp/build-dev/

# Run Image
docker run -d --name=builder-dev -v $PWD:/src/app builder-dev
